export OPERATING_SYSTEM=`lsb_release -is | tr [:upper:] [:lower:]`
export ARCHITECTURE=`uname -m`

if [ "${ARCHITECTURE}" == "x86_64" ]; then
	ARCHITECTURE="amd64"
fi

case $OPERATING_SYSTEM in
	centos|redhatenterpriseserver)
		export INSTALL="sudo yum -y install"
		export REMOVE="sudo yum remove"
		export UPDATE="sudo yum -y update"
		;;
	ubuntu|debian)
		export INSTALL="sudo apt-get -y install"
		export REMOVE="sudo apt-get remove"
		export UPDATE="sudo apt-get -y update"
		;;
	*)
		echo "Operating system not supported by script."
esac

function docker_install() {
	${UPDATE}
	install_dependencies
	add_gpg_key
	setup_stable_repository
	install_docker
	say_hello
	echo ""
	echo "Docker installed!"
}

function docker_remove() {
	if [ "${OPERATING_SYSTEM}" == "centos" ] || [ "${OPERATING_SYSTEM}" == "redhatenterpriseserver" ]; then
		$REMOVE docker docker-ce docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker logrotate docker-engine
	else
		$REMOVE docker docker-engine docker.io containerd runc
	fi
}

function install_dependencies() {
	echo " >>>>> Installing Dependencies..."
	install_lsb_release;
	if [ "${OPERATING_SYSTEM}" == "centos" ] || [ "${OPERATING_SYSTEM}" == "redhatenterpriseserver" ]; then
		$INSTALL unzip \
			yum-utils \
			device-mapper-persistent-data \
			lvm2
	else
		$INSTALL apt-transport-https \
			ca-certificates \
			curl \
			gnupg-agent \
			software-properties-common
	fi
	echo "install_dependencies END"
}

function add_gpg_key() {
	echo " >>>>> adding GPG key..."
	if [ "${OPERATING_SYSTEM}" != "centos" ] && [ "${OPERATING_SYSTEM}" != "redhatenterpriseserver" ]; then
		curl -fsSL https://download.docker.com/linux/${OPERATING_SYSTEM}/gpg | sudo apt-key add -
	fi
}

function setup_stable_repository() {
	echo " >>>>> setting up stable repository..."
	if [ "${OPERATING_SYSTEM}" == "centos" ] || [ "${OPERATING_SYSTEM}" == "redhatenterpriseserver" ]; then
		sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
	else
		sudo add-apt-repository \
			"deb [arch=${ARCHITECTURE}] https://download.docker.com/linux/${OPERATING_SYSTEM} \
			$(lsb_release -cs) \
			stable"
	fi
}

function install_docker() {
	echo " >>>>> update..."
	$UPDATE
	echo " >>>>> installing docker-ce..."
	$INSTALL docker-ce docker-ce-cli containerd.io
}

function say_hello() {
	echo " >>>>> hello from docker..."
	sudo docker run hello-world
}

function install_lsb_release() {
	echo "   >>>>> installing lsb_release utility..."
	lsb_release -is > /dev/null 2>&1
	if [ $? -ne 0 ]; then
		if [ "${OPERATING_SYSTEM}" == "centos"]	|| [ "${OPERATING_SYSTEM}" == "redhatenterpriseserver" ]; then
			${INSTALL} redhat-lsb-core 
		else
			${INSTALL} lsb-release
		fi
	fi
}

export OPERATION=`echo $1 | tr [:upper:] [:lower:]`
OPERATION=${OPERATION:-"install"}
case $OPERATION in
	install)
		echo ""
		echo "operating system : ${OPERATING_SYSTEM}"
		echo "architecture : `uname -m`"
		echo ""
		docker_install
	;;
	remove)
		echo "remove"
		docker_remove
	;;
	*)
		echo ""
esac

